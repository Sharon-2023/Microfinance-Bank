{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    .navbar {
      display: flex;
      align-items: center;
      background-color: #232041;
      padding: 6px 15px;
      color: white;
      min-height: 40px;
    }

    .navbar img {
      height: 30px;
      width: auto;
      margin-right: 8px;
      margin-left: 5px;
    }

    .navbar h1 {
      font-size: 20px;
      margin: 0;
      white-space: nowrap;
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      text-align: left;
    }

    h2 {
      text-align: center;
    }

    form {
      margin-top: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
    }

    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 15px;
    }

    button {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    button:hover {
      background-color: #3e8e41;
    }

    .progress-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .progress-bar .step {
      flex: 1;
      text-align: center;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .progress-bar .step.active {
      background-color: #4CAF50;
      color: white;
    }

    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
    }

    /* Live validation styles */
    .invalid {
      border-color: red;
    }

    .valid {
      border-color: green;
    }

    .error-message {
      color: red;
      font-size: 0.9em;
    }

  .success-message {
    color: green;
    font-size: 0.9em;
    margin-top: 5px;
  }

  .verification-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 20px;
  }

  .verification-item {
    width: 100%;
  }

  .verification-item label {
    display: block;
    margin-bottom: 5px;
  }

  .verification-item select,
  .verification-item input[type="file"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin-bottom: 5px;
  }

  .file-upload-container {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .file-upload-container input[type="file"] {
    flex-grow: 1;
  }

  .file-upload-container button {
    flex-shrink: 0;
    padding: 10px 20px;
  }

  .camera-container {
    margin: 20px 0;
    text-align: center;
  }

  .camera-buttons {
    margin: 10px 0;
  }

  .status-message {
    padding: 15px;
    margin: 10px 0;
    border-radius: 5px;
    font-size: 16px;
  }

  .status-message.error {
    background-color: #ffebee;
    color: #c62828;
    border: 1px solid #ffcdd2;
  }

  .status-message.success {
    background-color: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #c8e6c9;
  }

  video, img {
    width: 100%;
    max-width: 640px;
    margin: 10px auto;
    border-radius: 8px;
  }

  button {
    margin: 5px;
    padding: 8px 16px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  button:hover {
    background-color: #0056b3;
  }

  button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }

  .camera-guide {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: 2px solid #fff;
    border-radius: 50%;
    width: 200px;
    height: 200px;
    pointer-events: none;
  }

  #extractedFace {
    max-width: 200px;
    margin-top: 10px;
  }

  .verification-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
  }

  .verification-item {
    margin-bottom: 30px;
  }

  .status-message {
    padding: 15px;
    border-radius: 4px;
    margin-top: 10px;
  }

  .status-message.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .status-message.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  #extractedFace {
    max-width: 200px;
    margin-top: 10px;
  }

  video, canvas {
    max-width: 100%;
    margin-top: 10px;
  }

  .file-upload-container {
    margin-bottom: 15px;
  }

  button {
    padding: 8px 16px;
    margin: 5px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }

  .error-message {
    color: #dc3545;
    margin-top: 5px;
  }

  .success-message {
    color: #28a745;
    margin-top: 5px;
  }

  </style>
</head>
<body>
  <div class="navbar">
    <img src="{% static 'images/logo.png' %}" alt="Bank Logo">
    <h1>NanoWealth Bank</h1>
  </div>

  <div class="container">
    <h2>New User Sign Up</h2>

    <form id="signupForm" method="POST" action="{% url 'signup' %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="progress-bar">
        <div class="step active" data-step="1">Step 1</div>
        <div class="step" data-step="2">Step 2</div>
        <div class="step" data-step="3">Step 3</div>
      </div>

      <div class="step-content active" id="step-1">
        <h3>Customer Details</h3>
        <label for="dob">Date of Birth:</label>
        <input type="date" id="dob" name="dob" required>
       
        <label for="mobilenum">Mobile Number:</label>
        <input type="text" id="mobilenum" name="mobilenum" required placeholder="+1 1234567890">
        <div id="phoneError" class="error-message" style="display: none;">Please enter a valid mobile number.</div>

        <label for="name">Customer Name</label>
        <input type="text" id="customername" name="customername" required placeholder="Customer Name">
        <div id="nameError" class="error-message" style="display: none;">Name must start with a capital letter for each part and contain only letters (e.g., John Doe).</div>

        <button type="button" onclick="nextStep()">Proceed</button>
        <button type="reset">Back</button>
        <button type="button" onclick="cancelSignup()">Cancel</button>
      </div>

      <div class="step-content" id="step-2">
        <h3>Email Authentication</h3>
        <label for="email">Email:</label>
        <input type="text" id="email" name="email" required>
        <button type="button" onclick="nextStep()">Proceed</button>
        <button type="button" onclick="prevStep()">Back</button>
        <button type="button" onclick="cancelSignup()">Cancel</button>
      </div>

      <!-- Step 3 content -->
<div class="step-content" id="step-3">
  <h3>User Details</h3>
  <label for="username">Username:</label>
  <input type="text" id="username" name="username" required placeholder="Username">
  <div id="usernameError" class="error-message" style="display: none;">Username must be alphanumeric.</div>

  <label for="password">Password:</label>
  <input type="password" id="password" name="password" required>

  <div class="verification-container">
    <div class="verification-item">
      <h3>Step 1: Upload Government ID</h3>
      <div class="file-upload-container">
        <input type="file" id="document_upload" name="document_upload" accept=".jpg,.jpeg,.png,.pdf" required>
        <button type="button" id="uploadBtn">Process Document</button>
      </div>
      <div id="documentError" class="error-message" style="display: none;"></div>
      <div id="documentSuccess" class="success-message" style="display: none;"></div>
      <canvas id="extractedFace" style="display: none;"></canvas>
    </div>

    <div class="verification-item">
      <h3>Step 2: Live Photo Verification</h3>
      <div id="cameraSection">
        <video id="video" style="display: none;"></video>
        <canvas id="canvas" style="display: none;"></canvas>
        <img id="captured_photo" style="display: none;" alt="Captured photo">
        <button type="button" id="startCamera">Start Camera</button>
        <button type="button" id="capturePhoto" style="display: none;">Take Photo</button>
        <button type="button" id="retakePhoto" style="display: none;">Retake Photo</button>
      </div>
    </div>

    <div class="verification-item">
      <div id="kycStatus" class="status-message" style="display: none;"></div>
    </div>
  </div>

  <button type="submit">Submit</button>
  <button type="button" onclick="prevStep()">Back</button>
  <button type="button" onclick="cancelSignup()">Cancel</button>
</div>


      <p>Please Note:</p>
      <ul>
        <li>Please input valid customer details.</li>
      </ul>
    </form>
  </div>

  <!-- Update the libraries section -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/deepface-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <script>
  let documentFace = null;
  let liveFace = null;
  let faceDetectionNet;
  let isFaceDetectionModelLoaded = false;

  // Initialize PDF.js
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  // Update the model loading function to include all required models
  async function loadFaceDetectionModels() {
      try {
          await faceapi.nets.ssdMobilenetv1.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights');
          await faceapi.nets.faceLandmark68Net.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights');
          await faceapi.nets.faceRecognitionNet.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights');
          isFaceDetectionModelLoaded = true;
          console.log('All face detection models loaded successfully');
      } catch (error) {
          console.error('Error loading face detection models:', error);
          throw new Error('Failed to load face detection models');
      }
  }

  // Initialize when document is ready
  document.addEventListener('DOMContentLoaded', async () => {
      try {
          console.log('Loading face detection models...');
          await loadFaceDetectionModels();
          console.log('Face detection models loaded successfully');
          document.getElementById('uploadBtn').addEventListener('click', processDocument);
          document.getElementById('startCamera').addEventListener('click', startCamera);
          document.getElementById('capturePhoto').addEventListener('click', capturePhoto);
          document.getElementById('retakePhoto').addEventListener('click', retakePhoto);
      } catch (error) {
          showError('Error initializing: ' + error.message);
      }
  });

  async function extractFaceFromImage(img) {
      if (!isFaceDetectionModelLoaded) {
          await loadFaceDetectionModels();
      }

      try {
          const detections = await faceapi.detectSingleFace(img)
              .withFaceLandmarks()
              .withFaceDescriptor();

          if (!detections) {
              throw new Error('No face detected in image');
          }

          const box = detections.detection.box;
          const canvas = document.createElement('canvas');
          const padding = 50;
          
          canvas.width = box.width + (padding * 2);
          canvas.height = box.height + (padding * 2);
          
          const context = canvas.getContext('2d');
          context.drawImage(
              img,
              box.x - padding,
              box.y - padding,
              box.width + (padding * 2),
              box.height + (padding * 2),
              0,
              0,
              canvas.width,
              canvas.height
          );

          return canvas;
      } catch (error) {
          console.error('Face extraction error:', error);
          throw new Error('Failed to extract face from image');
      }
  }

  // Add this helper function to load images
  async function loadImage(file) {
      return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = (error) => reject(new Error('Failed to load image: ' + error.message));
          img.src = URL.createObjectURL(file);
      });
  }

  async function processDocument() {
      const fileInput = document.getElementById('document_upload');
      const file = fileInput.files[0];
      const documentError = document.getElementById('documentError');
      const documentSuccess = document.getElementById('documentSuccess');

      if (!file) {
          showError('Please select a document first');
          return;
      }

      try {
          documentSuccess.textContent = 'Processing document...';
          documentSuccess.style.display = 'block';
          documentError.style.display = 'none';

          let img;
          if (file.type === 'application/pdf') {
              console.log('Processing PDF file...');
              img = await processPDF(file);
          } else if (file.type.startsWith('image/')) {
              console.log('Processing image file...');
              img = await loadImage(file);
          } else {
              throw new Error('Unsupported file type. Please upload an image (JPG, PNG) or PDF.');
          }

          // Check if models are loaded
          if (!isFaceDetectionModelLoaded) {
              await loadFaceDetectionModels();
          }

          console.log('Detecting face in document...');
          const detection = await faceapi.detectSingleFace(img).withFaceLandmarks();

          if (!detection) {
              throw new Error('No face detected in document');
          }

          // Create canvas for extracted face
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
         
          // Add padding around the face
          const box = detection.detection.box;
          const padding = 50;
          canvas.width = box.width + (padding * 2);
          canvas.height = box.height + (padding * 2);

          // Draw the face region to the canvas
          context.drawImage(
              img,
              box.x - padding,
              box.y - padding,
              box.width + (padding * 2),
              box.height + (padding * 2),
              0,
              0,
              canvas.width,
              canvas.height
          );

          // Store the face canvas
          documentFace = canvas;

          // Display the extracted face
          const extractedFaceCanvas = document.getElementById('extractedFace');
          extractedFaceCanvas.style.display = 'block';
          extractedFaceCanvas.width = canvas.width;
          extractedFaceCanvas.height = canvas.height;
          extractedFaceCanvas.getContext('2d').drawImage(canvas, 0, 0);

          // Show success message
          documentSuccess.textContent = 'Face extracted successfully. Please proceed with live photo.';
          document.getElementById('startCamera').disabled = false;

      } catch (error) {
          console.error('Document processing error:', error);
          showError('Error processing document: ' + error.message);
      }
  }

  async function processPDF(file) {
      try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
          const page = await pdf.getPage(1); // Get first page

          // Set canvas dimensions based on PDF page
          const viewport = page.getViewport({ scale: 1.5 }); // Adjust scale as needed
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.width = viewport.width;
          canvas.height = viewport.height;

          // Render PDF page to canvas
          await page.render({
              canvasContext: context,
              viewport: viewport
          }).promise;

          // Convert canvas to image
          const img = new Image();
          return new Promise((resolve, reject) => {
              img.onload = () => resolve(img);
              img.onerror = reject;
              img.src = canvas.toDataURL('image/jpeg');
          });
      } catch (error) {
          console.error('PDF processing error:', error);
          throw new Error('Failed to process PDF document');
      }
  }

  // Helper function to show errors
  function showError(message) {
      console.error('Error:', message);
      const documentError = document.getElementById('documentError');
      const documentSuccess = document.getElementById('documentSuccess');
     
      documentError.textContent = message;
      documentError.style.display = 'block';
      documentSuccess.style.display = 'none';
  }

  async function startCamera() {
      const video = document.getElementById('video');
      const startButton = document.getElementById('startCamera');
      const captureButton = document.getElementById('capturePhoto');

      try {
          // Request camera access with specific constraints
          const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                  width: { ideal: 640 },
                  height: { ideal: 480 },
                  facingMode: 'user'
              }
          });

          // Set video source and show video element
          video.srcObject = stream;
          video.style.display = 'block';
          await video.play();

          // Hide start button and show capture button
          startButton.style.display = 'none';
          captureButton.style.display = 'inline-block';

      } catch (error) {
          console.error('Camera access error:', error);
          showError('Error accessing camera: ' + error.message);
      }
  }

  async function capturePhoto() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const capturedPhoto = document.getElementById('captured_photo');
      const captureButton = document.getElementById('capturePhoto');
      const retakeButton = document.getElementById('retakePhoto');

      try {
          // Set canvas dimensions to match video
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          
          // Draw video frame to canvas
          const context = canvas.getContext('2d');
          context.drawImage(video, 0, 0, canvas.width, canvas.height);

          // Extract face from captured photo
          liveFace = await extractFaceFromImage(canvas);

          if (liveFace) {
              // Stop video stream
              const stream = video.srcObject;
              stream.getTracks().forEach(track => track.stop());

              // Update display
              video.style.display = 'none';
              captureButton.style.display = 'none';
              retakeButton.style.display = 'inline-block';

              // Show captured photo
              capturedPhoto.src = liveFace.toDataURL('image/jpeg');
              capturedPhoto.style.display = 'block';

              // Verify faces if document face is available
              if (documentFace) {
                  await verifyFaces();
              }
          }
      } catch (error) {
          console.error('Photo capture error:', error);
          showError('Error capturing photo: ' + error.message);
      }
  }

  function retakePhoto() {
      const video = document.getElementById('video');
      const capturedPhoto = document.getElementById('captured_photo');
      const startButton = document.getElementById('startCamera');
      const retakeButton = document.getElementById('retakePhoto');
      const kycStatus = document.getElementById('kycStatus');

      // Reset display
      capturedPhoto.style.display = 'none';
      retakeButton.style.display = 'none';
      startButton.style.display = 'inline-block';
      kycStatus.style.display = 'none';

      // Clear previous capture
      liveFace = null;

      // Stop any existing stream
      if (video.srcObject) {
          const stream = video.srcObject;
          stream.getTracks().forEach(track => track.stop());
      }
  }

  async function verifyFaces() {
      const kycStatus = document.getElementById('kycStatus');
      kycStatus.style.display = 'block';
      kycStatus.textContent = 'Verifying faces...';
      kycStatus.className = 'status-message';

      try {
          if (!documentFace || !liveFace) {
              throw new Error('Both document and live photos are required');
          }

          // Convert canvases to base64 strings
          const docImageData = documentFace.toDataURL('image/jpeg');
          const liveImageData = liveFace.toDataURL('image/jpeg');

          // Create FormData object
          const formData = new FormData();
          formData.append('document_face', docImageData);
          formData.append('live_face', liveImageData);

          // Get CSRF token
          const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

          // Send to server for verification
          const response = await fetch('/verify-faces/', {
              method: 'POST',
              body: formData,
              headers: {
                  'X-CSRFToken': csrftoken
              }
          });

          const data = await response.json();

          if (data.success) {
              kycStatus.className = 'status-message success';
              kycStatus.textContent = `KYC SUCCESSFUL (Similarity: ${data.similarity.toFixed(2)}%)`;
              return true;
          } else {
              kycStatus.className = 'status-message error';
              kycStatus.textContent = data.message || 'Face verification failed';
              return false;
          }
      } catch (error) {
          console.error('Verification error:', error);
          kycStatus.className = 'status-message error';
          kycStatus.textContent = error.message || 'Face verification failed';
          return false;
      }
  }

  let currentStep = 1;
  const totalSteps = 3;

  function nextStep() {
      // Get the current step content and next step content
      const currentStepContent = document.getElementById(`step-${currentStep}`);
      const nextStepNumber = currentStep + 1;
      const nextStepContent = document.getElementById(`step-${nextStepNumber}`);

      // Hide current step
      currentStepContent.classList.remove('active');
      
      // Show next step
      nextStepContent.classList.add('active');
      
      // Update progress bar
      document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');
      document.querySelector(`.step[data-step="${nextStepNumber}"]`).classList.add('active');
      
      // Update current step
      currentStep = nextStepNumber;
  }

  function prevStep() {
      if (currentStep > 1) {
          // Hide current step
          document.getElementById(`step-${currentStep}`).classList.remove('active');
          
          // Show previous step
          const prevStepNumber = currentStep - 1;
          document.getElementById(`step-${prevStepNumber}`).classList.add('active');
          
          // Update progress bar
          document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');
          document.querySelector(`.step[data-step="${prevStepNumber}"]`).classList.add('active');
          
          // Update current step
          currentStep = prevStepNumber;
      }
  }

  function cancelSignup() {
      if (confirm('Are you sure you want to cancel the signup process?')) {
          window.location.href = '/';  // Redirect to home page
      }
  }
  </script>

  <!-- Add PDF.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
</body>
</html>

